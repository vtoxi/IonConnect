; PlatformIO Project Configuration File for ESP-01 Minimal Example
;
; This configuration is optimized for low-memory devices like ESP-01
; with minimal features enabled to reduce RAM and flash usage.
;
; Build environments:
; - esp01_1m: ESP-01 with 1MB flash (most common)
; - esp01_512k: ESP-01 with 512KB flash (older modules)

[platformio]
default_envs = esp01_1m

[env]
; Common settings for all environments
platform = espressif8266
framework = arduino

; Core libraries
lib_deps = 
    IonConnect
    ESPAsyncTCP
    ESPAsyncWebServer
    ArduinoJson@^6.21.0

; Minimal mode and memory optimizations
build_flags = 
    ; Enable IonConnect minimal mode
    -DION_MINIMAL_MODE=1
    
    ; ESP8266 memory optimizations
    -DPIO_FRAMEWORK_ARDUINO_LWIP2_LOW_MEMORY
    -D PIO_FRAMEWORK_ARDUINO_MMU_CACHE16_IRAM48
    
    ; Disable debug output in production
    ;-D DEBUG_ESP_PORT=
    ;-D NDEBUG
    
    ; Optimize for size
    -Os
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
    
    ; Further reduce memory (optional)
    ;-DION_JSON_SCHEMA_SIZE=768
    ;-DION_JSON_CONFIG_SIZE=384
    ;-DION_JSON_BUFFER_SIZE=384

; Serial monitor settings
monitor_speed = 115200
monitor_filters = 
    esp8266_exception_decoder
    time

; Upload settings
upload_speed = 115200
upload_resetmethod = nodemcu

; ============================================
; ESP-01 with 1MB Flash (Most Common)
; ============================================
[env:esp01_1m]
board = esp01_1m

; Flash layout for 1MB
board_build.flash_mode = dio
board_build.f_cpu = 80000000L
board_build.f_flash = 40000000L
board_build.ldscript = eagle.flash.1m64.ld

; ============================================
; ESP-01 with 512KB Flash (Older Modules)
; ============================================
[env:esp01_512k]
board = esp01

; Flash layout for 512KB (very tight!)
board_build.flash_mode = dio
board_build.f_cpu = 80000000L
board_build.f_flash = 40000000L
board_build.ldscript = eagle.flash.512k0.ld

; Even more aggressive optimizations for 512KB
build_flags = 
    ${env.build_flags}
    -DION_JSON_SCHEMA_SIZE=512
    -DION_JSON_CONFIG_SIZE=256
    -DION_JSON_BUFFER_SIZE=256
    -DION_MAX_NETWORKS=2
    -DION_MAX_CONFIG_FIELDS=6
    -D NDEBUG  ; Disable debug to save space

; ============================================
; Development Build (More Debugging)
; ============================================
[env:esp01_dev]
extends = env:esp01_1m

; Enable debug output
build_flags = 
    ${env.build_flags}
    -D DEBUG_ESP_PORT=Serial
    -D DEBUG_ESP_WIFI
    -D ION_DEBUG=1

monitor_filters = 
    esp8266_exception_decoder
    time
    colorize

; ============================================
; Production Build (Maximum Optimization)
; ============================================
[env:esp01_prod]
extends = env:esp01_1m

; Maximum optimizations for production
build_flags = 
    ${env.build_flags}
    -D NDEBUG
    -D DEBUG_ESP_PORT=
    -flto
    -Wl,-flto

build_unflags = 
    -Os

; Use -Os for even smaller size
custom_build_flags = 
    -Os

